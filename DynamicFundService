package au.com.cfs.winged.core.services;

import au.com.cfs.winged.core.common.constants.ApplicationConstants;
import com.day.cq.dam.api.Asset;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.json.JSONArray;
import org.json.JSONException;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;

import java.util.Map;
import java.util.TreeMap;

@Component(service = DynamicFundService.class)
public class DynamicFundService {

	private static final Logger LOG = LoggerFactory.getLogger(DynamicFundService.class);

	private String companyCode;
	private String api;
	private String fundLinkBaseUrl;

	public String getCompanyCode() {
		return companyCode;
	}

	public String getApi() {
		return api;
	}

	public String getFundLinkBaseUrl() {
		return fundLinkBaseUrl;
	}

	public void fetchAndSetValues(ResourceResolver resourceResolver) throws IOException, JSONException {

		Resource resource = resourceResolver.getResource(ApplicationConstants.END_POINT_LIST_PATH);
		Asset asset = resource.adaptTo(Asset.class);
		Resource original;
		original = asset.getOriginal();
		InputStream jsonContent = original.adaptTo(InputStream.class);
		StringBuilder stringBuilder = new StringBuilder();
		String eachLine;
		BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(jsonContent, StandardCharsets.UTF_8));

		while((eachLine = bufferedReader.readLine()) != null) {
			stringBuilder.append(eachLine);
		}
		JSONArray jsonArray = new JSONArray(stringBuilder.toString());
		Map<String, String> data = new TreeMap<>();
		for(int i = 0; i < jsonArray.length(); i++) {
			data.put(jsonArray.getJSONObject(i).getString("text"), jsonArray.getJSONObject(i).getString("value"));
		}

		setCompanyCode(data.get("companyCode"));
		setApi(data.get("api"));
		setFundLinkBaseUrl(data.get("fundLinkBaseUrl"));
	}

	private void setCompanyCode(String companyCode) {
		this.companyCode = companyCode;
	}

	private void setApi(String api) {
		this.api = api;
	}

	private void setFundLinkBaseUrl(String fundLinkBaseUrl) {
		this.fundLinkBaseUrl = fundLinkBaseUrl;
	}
}
