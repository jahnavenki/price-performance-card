package au.com.cfs.winged.core.services;

import au.com.cfs.winged.core.common.constants.ApplicationConstants;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.json.JSONArray;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.Map;
import java.util.Objects;
import java.util.TreeMap;

@Component(service = DynamicFundService.class)
public class DynamicFundService {
    private static final Logger LOG = LoggerFactory.getLogger(DynamicFundService.class);

    private String companyCode;
    private String api;
    private String fundLinkBaseUrl;

    public String getCompanyCode() {
        return companyCode;
    }

    public void setCompanyCode(String companyCode) {
        this.companyCode = companyCode;
    }

    public String getApi() {
        return api;
    }

    public void setApi(String api) {
        this.api = api;
    }

    public String getFundLinkBaseUrl() {
        return fundLinkBaseUrl;
    }

    public void setFundLinkBaseUrl(String fundLinkBaseUrl) {
        this.fundLinkBaseUrl = fundLinkBaseUrl;
    }

    public void fetchAndSetValues(ResourceResolver resourceResolver) {
        Resource resource = resourceResolver.getResource(ApplicationConstants.END_POINT_LIST_PATH);
        if (resource == null) {
            LOG.error("Resource not found at path: {}", ApplicationConstants.END_POINT_LIST_PATH);
            return;
        }

        try {
            // Adapt this to InputStream
            InputStream content = Objects.requireNonNull(resource).adaptTo(InputStream.class);
            if (content == null) {
                LOG.error("Failed to adapt resource to InputStream at path: {}", ApplicationConstants.END_POINT_LIST_PATH);
                return;
            }

            // Read all the data in the json file as a string
            StringBuilder jsonContent = new StringBuilder();
            BufferedReader jsonReader = new BufferedReader(
                    new InputStreamReader(content, StandardCharsets.UTF_8));

            // Loop through each line
            String line;
            while ((line = jsonReader.readLine()) != null) {
                jsonContent.append(line);
            }

            // Parse JSON content
            JSONArray jsonArray = new JSONArray(jsonContent.toString());
            Map<String, String> data = new TreeMap<>();
            for (int i = 0; i < jsonArray.length(); i++) {
                data.put(jsonArray.getJSONObject(i).getString("text"),
                        jsonArray.getJSONObject(i).getString("value"));
            }

            // Set values
            setCompanyCode(data.get("companyCode"));
            setApi(data.get("api"));
            setFundLinkBaseUrl(data.get("fundLinkBaseUrl"));

            LOG.info("Values fetched and set successfully: companyCode={}, api={}, fundLinkBaseUrl={}",
                    companyCode, api, fundLinkBaseUrl);
        } catch (Exception e) {
            LOG.error("Exception occurred while fetching and setting values", e);
        }
    }
}

...........................................
                    package au.com.cfs.winged.core.models;

import au.com.cfs.winged.core.models.common.ButtonsModel;
import au.com.cfs.winged.core.services.DynamicFundService;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.resource.ResourceResolver;
import org.apache.sling.models.annotations.DefaultInjectionStrategy;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.injectorspecific.OSGiService;
import org.apache.sling.models.annotations.injectorspecific.ValueMapValue;

import javax.annotation.PostConstruct;
import javax.inject.Inject;

@Model(adaptables = SlingHttpServletRequest.class, adapters = DynamicFundCardModel.class, defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL)
public class DynamicFundCardModel extends ButtonsModel {

    @Inject
    private ResourceResolver resourceResolver;

    @ValueMapValue
    private String layout;

    @ValueMapValue
    private String cardSize;

    @ValueMapValue
    private String apir;

    @ValueMapValue
    private String inception;

    @ValueMapValue
    private String content;

    @ValueMapValue
    private String imageUrl;

    @ValueMapValue
    private String horizontalLine;

    @ValueMapValue
    private String verticalLine;

    @ValueMapValue
    private String mainGroup;

    @ValueMapValue
    private String product;

    @ValueMapValue
    private String year;

    private String companyCode;

    private String api;

    private String fundLinkBaseUrl;

    @OSGiService
    private DynamicFundService dynamicFundService;

    @PostConstruct
    protected void init() {
        // Fetch and set values in DynamicFundService
        dynamicFundService.fetchAndSetValues(resourceResolver);

        // Initialize model fields with values from DynamicFundService
        companyCode = dynamicFundService.getCompanyCode();
        api = dynamicFundService.getApi();
        fundLinkBaseUrl = dynamicFundService.getFundLinkBaseUrl();
    }

    public String getLayout() {
        return layout;
    }

    public String getCardSize() {
        return cardSize;
    }

    public String getApir() {
        return apir;
    }

    public String getContent() {
        return content;
    }

    public String getImageUrl() {
        return imageUrl;
    }

    public String getHorizontalLine() {
        return horizontalLine;
    }

    public String getVerticalLine() {
        return verticalLine;
    }

    public String getMainGroup() {
        return mainGroup;
    }

    public String getProduct() {
        return product;
    }

    public String getYear() {
        return year;
    }

    public String getCompanyCode() {
        return companyCode;
    }

    public String getApi() {
        return api;
    }

    public String getInception() {
        return inception;
    }

    public String getFundLinkBaseUrl() {
        return fundLinkBaseUrl;
    }
}

                    
