package au.com.cfs.winged.core.services;

import au.com.cfs.winged.core.common.constants.ApplicationConstants;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.osgi.service.component.annotations.Component;

import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;

@Component(service = DynamicFundService.class)
public class DynamicFundService {
    private String companyCode;
    private String api;
    private String fundLinkBaseUrl;

    public String getCompanyCode() {
        return companyCode;
    }

    public void setCompanyCode(String companyCode) {
        this.companyCode = companyCode;
    }

    public String getApi() {
        return api;
    }

    public void setApi(String api) {
        this.api = api;
    }

    public String getFundLinkBaseUrl() {
        return fundLinkBaseUrl;
    }

    public void setFundLinkBaseUrl(String fundLinkBaseUrl) {
        this.fundLinkBaseUrl = fundLinkBaseUrl;
    }

    public void fetchAndSetValues(ResourceResolver resourceResolver) {
        Resource resource = resourceResolver.getResource(ApplicationConstants.END_POINT_LIST_PATH);
        if (resource != null) {
            try (InputStream inputStream = resource.adaptTo(InputStream.class);
                 InputStreamReader reader = new InputStreamReader(inputStream, StandardCharsets.UTF_8)) {

                JsonArray jsonArray = JsonParser.parseReader(reader).getAsJsonArray();
                Map<String, String> values = new HashMap<>();
                for (int i = 0; i < jsonArray.size(); i++) {
                    JsonObject jsonObject = jsonArray.get(i).getAsJsonObject();
                    String text = jsonObject.get("text").getAsString();
                    String value = jsonObject.get("value").getAsString();
                    values.put(text, value);
                }
                setCompanyCode(values.get("companyCode"));
                setApi(values.get("api"));
                setFundLinkBaseUrl(values.get("fundLinkBaseUrl"));
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
